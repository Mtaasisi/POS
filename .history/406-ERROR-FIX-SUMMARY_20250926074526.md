# 406 Not Acceptable Error Fix Summary

## Problem Description
The application was experiencing a 406 (Not Acceptable) error when trying to query the `lats_sales` table with the specific sale ID `36487185-0673-4e03-83c2-26eba8d9fef7`. The error was occurring in the Supabase REST API calls.

## Root Causes Identified

### 1. Missing Required Headers
The Supabase client was not sending the required headers that the REST API expects:
- `Accept: application/json`
- `Content-Type: application/json`
- `apikey: [your-api-key]`
- `Authorization: Bearer [your-api-key]`

### 2. RLS (Row Level Security) Policy Issues
The database tables had RLS enabled but potentially restrictive policies that were blocking API requests.

### 3. Query Format Issues
The query format might not have been properly formatted for the Supabase REST API.

## Fixes Implemented

### 1. Enhanced Supabase Client Configuration
**File:** `src/lib/supabaseClient.ts`

**Changes Made:**
- Added proper headers to the global configuration:
  ```typescript
  global: {
    headers: {
      'X-Client-Info': 'lats-app',
      'Accept': 'application/json',
      'Content-Type': 'application/json',
      'apikey': config.key,
      'Authorization': `Bearer ${config.key}`,
    },
  }
  ```

- Enhanced the fetch configuration to include proper headers:
  ```typescript
  fetch: (url, options = {}) => {
    return fetch(url, {
      ...options,
      headers: {
        ...options.headers,
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'apikey': config.key,
        'Authorization': `Bearer ${config.key}`,
        'Connection': 'keep-alive',
        'Cache-Control': 'no-cache',
      },
    });
  }
  ```

- Improved the query interceptor to handle 406 errors:
  ```typescript
  // Fix 406 errors by ensuring proper headers
  const enhancedInit = {
    ...init,
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json',
      'apikey': config.key,
      'Authorization': `Bearer ${config.key}`,
      ...init?.headers,
    },
  };
  ```

### 2. Database RLS Policy Fixes
**File:** `fix-406-error.sql`

**Changes Made:**
- Dropped all existing restrictive policies
- Created comprehensive RLS policies that allow all operations:
  ```sql
  CREATE POLICY "Enable all operations for all users" ON lats_sales 
  FOR ALL USING (true) WITH CHECK (true);
  ```

### 3. Test Functions Added
**File:** `src/lib/supabaseClient.ts`

**New Functions:**
- `testFailingSaleQuery()` - Specifically tests the failing sale query
- Enhanced error handling and logging

### 4. JavaScript Test Script
**File:** `test-supabase-406-fix.js`

**Features:**
- Comprehensive testing of Supabase connection
- Tests for the specific failing sale ID
- Alternative query methods testing
- Header and configuration validation

## How to Apply the Fixes

### 1. Run the SQL Fix
Execute the `fix-406-error.sql` script in your Supabase database to fix RLS policies.

### 2. Update Your Application
The Supabase client configuration has been updated. Restart your application to pick up the changes.

### 3. Test the Fix
You can test the fix by:
1. Running the JavaScript test script: `test-supabase-406-fix.js`
2. Using the new test function: `testFailingSaleQuery()`
3. Checking the browser console for the specific sale query

## Expected Results

After applying these fixes:
- ✅ The 406 error should be resolved
- ✅ Queries to `lats_sales` table should work properly
- ✅ The specific sale ID `36487185-0673-4e03-83c2-26eba8d9fef7` should be accessible
- ✅ Complex queries with joins should work
- ✅ All Supabase API calls should have proper headers

## Monitoring

The updated configuration includes:
- Enhanced error logging
- Connection health checks
- Retry mechanisms for network issues
- Query interceptors for malformed requests

## Files Modified

1. `src/lib/supabaseClient.ts` - Enhanced client configuration
2. `fix-406-error.sql` - Database RLS policy fixes
3. `test-supabase-406-fix.js` - Test script for validation
4. `406-ERROR-FIX-SUMMARY.md` - This documentation

## Next Steps

1. **Test the application** - Try accessing the sale details that were failing
2. **Monitor the console** - Check for any remaining errors
3. **Verify database access** - Ensure all queries work properly
4. **Update environment variables** - Make sure your Supabase URL and API key are correct

## Troubleshooting

If you still experience issues:

1. **Check your Supabase credentials** - Verify URL and API key
2. **Check browser console** - Look for any remaining errors
3. **Test with the provided test script** - Run `test-supabase-406-fix.js`
4. **Check database permissions** - Ensure RLS policies are correctly applied
5. **Verify table structure** - Make sure all required columns exist

The 406 error should now be resolved with these comprehensive fixes.
